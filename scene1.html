<html>
  <head>

    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-animation-component@3.2.1/dist/aframe-animation-component.min.js"></script>
    <script src="https://unpkg.com/aframe-particle-system-component@1.0.x/dist/aframe-particle-system-component.min.js"></script>
    <script src="https://unpkg.com/aframe-extras.ocean@%5E3.5.x/dist/aframe-extras.ocean.min.js"></script>
    <script src="https://unpkg.com/aframe-gradient-sky@1.0.4/dist/gradientsky.min.js"></script>
    <script src="https://unpkg.com/aframe-extras.tube@%5E3.5.x/dist/aframe-extras.tube.min.js"></script>
    
    <script>
      var totalScore = 100;

      
      function gameover(score){
        if(score <= 0){
          document.querySelector('#cam').setAttribute("wasd-controls",{enabled: 'false'});
          document.querySelector("#gamescene").setAttribute("visible",false);
          document.querySelector("#gameover").setAttribute("visible",true);
        }
        return;
      }
      

      function updateScore(score){
        var scoreEl = document.querySelector('#scoreMsg');
        scoreEl.setAttribute('text', {
                    align:'center',
                    width:3,
                    wrapCount:100,
                    color:'black',
                    value: 'Score: ' + score
                  });

        gameover(score);

      }
      
      AFRAME.registerComponent('collider-check-game', {
        init: function() {
          var timeOut;
          this.el.addEventListener('raycaster-intersected', function(e) {
              var collMsg = document.querySelector("#msg2");
              clearTimeout(timeOut);
              collMsg.setAttribute('text', {
                align:'center',
                width:3,
                wrapCount:100,
                color:'red',
                value:'You have hit ' + e.target.id
            });
            totalScore -= 10;
            updateScore(totalScore);
            
            timeOut = setTimeout(function(){
              collMsg.setAttribute('text', {
              align:'center',
              width:3,
              wrapCount:100,
              color:'red',
              value:''
              });
            }, 3000);
          });
        }
      });
      
      AFRAME.registerComponent('collider-check-over', {
        init: function() {
          var material;
          this.el.addEventListener('raycaster-intersected', function(e) {
            console.log("player collided " + e.target.id);
            material = e.target.getAttribute('material');
            e.target.setAttribute('material', {
              color: 'green',
              shader: 'flat'
            });
            
          });
          this.el.addEventListener('raycaster-intersected-cleared', function(e) {
            console.log("player left");
            e.target.setAttribute('material', material);
            
          });
        }
      });
    </script>
  </head>
  <body class="a-body ">
    
    
    <a-scene id="gamescene" collider-check-game>
      <a-assets>
        <a-asset-item id="car1-obj" src="assets/obj/veh_car1.obj"></a-asset-item>
        <a-asset-item id="car1-mtl" src="assets/obj/veh_car1.mtl"></a-asset-item>
        <a-asset-item id="car2-obj" src="assets/obj/veh_car2.obj"></a-asset-item>
        <a-asset-item id="car2-mtl" src="assets/obj/veh_car2.mtl"></a-asset-item>
        <a-asset-item id="chr-obj" src="assets/obj/chr_sports1.obj"></a-asset-item>
        <a-asset-item id="chr-mtl" src="assets/obj/chr_sports1.mtl"></a-asset-item>
        <a-asset-item id="driveway1-obj" src="assets/obj/obj_driveway3.obj"></a-asset-item>
        <a-asset-item id="driveway1-mtl" src="assets/obj/obj_driveway3.mtl"></a-asset-item>
        <a-asset-item id="sidewalk1-obj" src="assets/obj/obj_sidewalk1.obj"></a-asset-item>
        <a-asset-item id="sidewalk1-mtl" src="assets/obj/obj_sidewalk1.mtl"></a-asset-item>
        <a-asset-item id="base-obj" src="assets/obj/base_street1.obj"></a-asset-item>
        <a-asset-item id="base-mtl" src="assets/obj/base_street1.mtl"></a-asset-item>
        <img id="sky" src="https://img.gs/bbdkhfbzkk/2048x2048,stretch/http://i.imgur.com/WqlqEkq.jpg" crossorigin="anonymous" />
      </a-assets> 
      
  

      
      
      <a-entity position="8 1.6 0" >
        <a-camera id="cam" user-height="1.6" wasd-controls="acceleration: 100" look-controls="pointerLockEnabled: true">
          
          <a-sphere raycaster="objects: .collidable; far: 0.4" geometry="radius:0.5"></a-sphere>
          <a-entity id="scoreMsg" position="0 1 -1.5" ></a-entity>
          <a-entity id="msg1" position="0 0.9 -1.5"></a-entity>
          <a-entity id="msg2" position="0 0.8 -1.5"></a-entity>
          
        </a-camera>
      </a-entity>
      
      
      <a-entity id="obj-entity1" class="collidable" position="-2.5 0.5 -30" geometry="primitive: box" rotation="0 180 0" scale="0.2 0.2 0.2" obj-model="obj: #car1-obj; mtl: #car1-mtl" animation="property: position; dir: forward; dur: 5000; to: -2.5 0.5 20; loop: true"></a-entity> 
      <a-entity id="obj-entity2" class="collidable" position="2.5 0.5 -30" geometry="primitive: box" rotation="0 180 0" scale="0.2 0.2 0.2" obj-model="obj: #car2-obj; mtl: #car2-mtl" animation="property: position; dir: forward; dur: 6000; to: 2.5 0.5 20; loop: true"></a-entity>
      <a-entity id="obj-entity3" class="collidable" position="7 0.55 -30" geometry="primitive: box" rotation="0 0 0" scale="0.15 0.15 0.15" obj-model="obj: #chr-obj; mtl: #chr-mtl" animation="property: position; dir: forward; dur: 30000; to: 7 0.55 20; loop: true"></a-entity> 
      <!-- 
      <a-plane position="-6 0.001 -4" rotation="-90 0 0" width="10" height="10" color="black" material="" geometry="width:5;height:50"></a-plane>
      <a-plane position="0 0.001 -4" rotation="-90 0 0" width="10" height="10" color="grey" material="" geometry="width:3;height:50"></a-plane>
      -->
      <a-plane position="8 0.5 -4" rotation="0 0 0" scale="0.3 0.1 3.6" obj-model="obj: #sidewalk1-obj; mtl: #sidewalk1-mtl"></a-plane>
      <a-plane position="0 0 -4" rotation="0 90 0" scale="1 0.5 0.5" obj-model="obj: #base-obj; mtl: #base-mtl"></a-plane>
      <a-sky color="#ECECEC" material="" geometry=""></a-sky>
    </a-scene>
    
    <a-scene id="gameover" collider-check-over> 
      <a-entity position="0 0 0">
        <a-camera user-height="1.6" wasd-controls-enabled="false" look-controls="pointerLockEnabled: true">
          <a-sphere raycaster="objects: .collidable" geometry="radius:0.1"></a-sphere>
          <a-cursor color ="white" ></a-cursor>    
        </a-camera>

      </a-entity>
      
      
      <a-entity position="0 0.3 -0.7" text="align: center; width: 10; wrapCount: 100; color: red; value: GAMEOVER"></a-entity> 
      <a-box id="retry" class="collidable" position="-0.2 0.1 -0.7" scale="0.2 0.15 0.1" rotation="0 0 0"  material="color: yellow; shader: flat;">
        <a-entity text="align: center; width: 20; wrapCount: 100; color: black; value: Retry" position="0 0 0.5"></a-entity>
      </a-box>
      <a-box id="back" class="collidable" position="0.2 0.1 -0.7" scale="0.2 0.15 0.1" rotation="0 0 0" material="color: red; shader: flat;">
        <a-entity text="align: center; width: 20; wrapCount: 100; color: black; value: Back" position="0 0 0.5"></a-entity>
      </a-box>

      <a-sky color="black" material="" geometry=""></a-sky>
    </a-scene>
    <script src="index.js"></script>
  </body>
</html>
